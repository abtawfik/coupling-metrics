'''
A set of functions that are not specific to any specific metric
Functions such as calculating saturation specific humidity or air density
'''

# 3rd party packages
import numpy as np
import pandas as pd
from toolz.curried import curry, compose

import constants as cnts

# Constants
p_ref = 1e5
Lv    = 2.5e6
cp    = 1005.7
grav  = 9.81
Rd    = 287.04
ep    = 0.622
R_cp  = Rd/cp

@curry
def air_density(p, t, q):
    return p / (Rd * t * ((1. + (q/ep)) / (1. + q)))

@curry
def temp_to_energy(t):
    return cp * t

@curry
def shum_to_latent_energy(q):
    return Lv * q

@curry
def bowen_ratio(sensible_heat, latent_heat):
    return np.where( latent_heat == 0, np.nan, sensible_heat / latent_heat )

def delta_surface_heat(rho, sensible_heat_flux, pbl_height, dt):
    return np.where( rho*pbl_height == 0, np.nan, (sensible_heat_flux * dt) / (rho * pbl_height) )

def surface_flux_increment(delta_heat, bowen, latent_energy, heat_energy):
    latent_increment    =  latent_energy  +  (delta_heat/bowen)
    sensible_increment  =  heat_energy    +  delta_heat
    return latent_increment, sensible_increment

dt             = 8 * 60 * 60
rho            = air_density(df.pres, df.t2m, df.q2m)
heat_energy    = temp_to_energy(df.t2m)
latent_energy  = latent_heat_energy(df.q2m)
bowen          = bowen_ratio(df.sh, df.lh)
dtheta         = delta_surface_heat(rho, df.sh, df.pblh, dt)

heat_previous = heat_energy.shift(1)
latent_previous = latent_energy.shift(1)

lh_inc, sh_inc = surface_flux_increment( dtheta, bowen, latent_previous, heat_previous)

def separate_energy_components():
    shf_tot = (heat_energy - heat_previous) * (rho * df.pblh) / dt
    shf_ent = (heat_energy - sh_inc       ) * (rho * df.pblh) / dt
    shf_sfc = (sh_inc      - heat_previous) * (rho * df.pblh) / dt

    lhf_tot = (Lv * ((latent_energy/Lv)  - (latent_previous / Lv)) * rho * df.pblh) / dt
    lhf_ent = (Lv * ((latent_energy/Lv)  - (lh_inc          / Lv)) * rho * df.pblh) / dt
    lhf_sfc = (Lv * ((lh_inc       /Lv)  - (latent_previous / Lv)) * rho * df.pblh) / dt

